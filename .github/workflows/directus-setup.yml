name: Directus CMS Setup

# Required repository secrets:
#   DIRECTUS_TOKEN           — preferred: static admin token (Settings → Access Tokens)
#   DIRECTUS_ADMIN_EMAIL     — fallback email  (if no token)
#   DIRECTUS_ADMIN_PASSWORD  — fallback password (if no token)
#
# Sensitive values MUST be stored as repository secrets (Settings → Secrets → Actions),
# never as plain workflow inputs — inputs are visible in logs even when not printed.

on:
  workflow_dispatch:
    inputs:
      directus_url:
        description: "Directus instance URL (e.g. https://cms.yourdomain.com)"
        required: true
        type: string

  workflow_call:
    inputs:
      directus_url:
        required: true
        type: string
    secrets:
      DIRECTUS_TOKEN:
        required: false
      DIRECTUS_ADMIN_EMAIL:
        required: false
      DIRECTUS_ADMIN_PASSWORD:
        required: false

jobs:
  setup:
    name: Setup Directus collections & seed data
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Mask sensitive values
        # Belt-and-suspenders: explicitly mask secrets so they never appear in any log line
        env:
          TOKEN: ${{ secrets.DIRECTUS_TOKEN }}
          PASSWORD: ${{ secrets.DIRECTUS_ADMIN_PASSWORD }}
        run: |
          if [ -n "$TOKEN" ];    then echo "::add-mask::$TOKEN";    fi
          if [ -n "$PASSWORD" ]; then echo "::add-mask::$PASSWORD"; fi

      - name: Wait for Directus to be reachable
        env:
          DIRECTUS_URL: ${{ inputs.directus_url }}
        run: |
          echo "Waiting for Directus at $DIRECTUS_URL …"
          for i in $(seq 1 12); do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$DIRECTUS_URL/server/health" || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "✓ Directus is up (attempt $i)"
              break
            fi
            echo "  attempt $i: status=$STATUS — retrying in 10s"
            sleep 10
          done
          if [ "$STATUS" != "200" ]; then
            echo "✗ Directus did not become healthy in time"
            exit 1
          fi

      - name: Run setup script
        env:
          DIRECTUS_URL: ${{ inputs.directus_url }}
          DIRECTUS_TOKEN: ${{ secrets.DIRECTUS_TOKEN }}
          DIRECTUS_ADMIN_EMAIL: ${{ secrets.DIRECTUS_ADMIN_EMAIL }}
          DIRECTUS_ADMIN_PASSWORD: ${{ secrets.DIRECTUS_ADMIN_PASSWORD }}
        run: npm run directus:setup
